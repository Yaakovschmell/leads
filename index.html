<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Training Scheduler</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

<!-- Firebase SDK (modular, v12.9.0) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCPgkOysIRXzw_yvMnSomcrkIxstp_TD88",
    authDomain: "trainingscheduler-ecfd4.firebaseapp.com",
    databaseURL: "https://trainingscheduler-ecfd4-default-rtdb.firebaseio.com",
    projectId: "trainingscheduler-ecfd4",
    storageBucket: "trainingscheduler-ecfd4.firebasestorage.app",
    messagingSenderId: "886466149785",
    appId: "1:886466149785:web:fa3489ad3b3bf47b8de708",
    measurementId: "G-QMVN5TNSZP"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Shared data path
  const dataRef = ref(db, 'schedulerData');

  // Real-time listener: load and update when data changes
  onValue(dataRef, (snapshot) => {
    const data = snapshot.val();
    console.log('Firebase data received:', data);
    if (data) {
      roster = data.roster || roster;
      schedule = data.schedule || schedule;
      renderPool();
      render();
      toast('âœ“ Synced from cloud');
    }
  }, (error) => {
    console.error('Firebase listener error:', error);
    toast('âš  Sync error â€“ check console');
  });

  // Save function to Firebase
  function saveToFirebase() {
    set(dataRef, { roster, schedule })
      .then(() => {
        console.log('Saved to Firebase successfully');
        toast('âœ“ Saved to cloud');
      })
      .catch(err => {
        console.error('Firebase save error:', err);
        toast('âš  Save failed â€“ check console');
      });
  }

  window.saveToFirebase = saveToFirebase;
</script>

<style>
:root{--bg:#1a1d24;--bg2:#21242c;--surface:#282c36;--card:#2e333e;--cyan:#22d3ee;--magenta:#ec4899;--green:#10b981;--yellow:#fbbf24;--text:#f8fafc;--text2:#cbd5e1;--text3:#94a3b8;--border:#3d4452}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:15px;line-height:1.5}
header{background:var(--bg2);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:14px}
.logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--cyan),var(--magenta));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px}
.logo h1{font-size:1.35rem;font-weight:700;letter-spacing:0.5px}
.logo p{font-size:.85rem;color:var(--text3);margin-top:2px}
.header-right{display:flex;gap:12px;align-items:center}
.week-nav{display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px 10px}
.week-nav button{background:none;border:none;cursor:pointer;color:var(--text2);font-size:20px;width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.week-nav button:hover{background:var(--cyan);color:#000}
.week-nav span{font-size:.95rem;font-weight:600;min-width:170px;text-align:center}
.btn{display:flex;align-items:center;gap:8px;padding:10px 18px;border-radius:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:.95rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.btn:hover{background:var(--cyan);color:#000;border-color:var(--cyan)}
.layout{display:grid;grid-template-columns:250px 1fr;min-height:calc(100vh - 68px)}
aside{background:var(--bg2);border-right:1px solid var(--border);padding:24px 18px;position:sticky;top:68px;height:calc(100vh - 68px);overflow-y:auto}
aside h2{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text2);margin-bottom:14px;padding:0 6px}
.pool{display:flex;flex-direction:column;gap:6px}
.chip{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:8px;cursor:grab;font-size:1rem;font-weight:500;border:1px solid var(--border);user-select:none;transition:all .15s;background:var(--surface)}
.chip:hover{border-color:var(--cyan);transform:translateX(2px)}
.chip:active{cursor:grabbing;transform:scale(.98)}
.chip.dragging{opacity:.25}
.avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:#000;flex-shrink:0}
.add-section{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
.add-section label{font-size:.85rem;font-weight:600;color:var(--text2);display:block;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.add-section input{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:11px 14px;border-radius:6px;font-size:1rem;outline:none;font-family:inherit}
.add-section input:focus{border-color:var(--cyan)}
.add-section button{margin-top:10px;width:100%;padding:11px;background:linear-gradient(135deg,var(--cyan),var(--magenta));color:#000;border:none;border-radius:6px;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit}
.add-section button:hover{filter:brightness(1.1)}
main{padding:32px;overflow-x:auto !important}
.stats{display:flex;gap:14px;margin-bottom:26px;flex-wrap:wrap}
.stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:18px 22px;min-width:140px}
.stat .sl{font-size:.8rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.stat .sv{font-size:1.9rem;font-weight:700;margin-top:4px}
.grid{display:grid;grid-template-columns:repeat(5, minmax(260px, 1fr));gap:16px;min-width:1300px;width:100%;overflow-x:auto !important;padding-bottom:16px}
.day-col{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;min-width:260px;flex-shrink:0}
.day-head{padding:16px 18px;border-bottom:1px solid var(--border);background:var(--surface)}
.day-head .dn{font-size:.9rem;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.day-head .dd{font-size:.85rem;color:var(--text3);margin-top:3px}
.slots{padding:12px;display:flex;flex-direction:column;gap:10px}
.slot{background:var(--surface);border:2px dashed var(--border);border-radius:10px;min-height:96px;padding:12px;transition:all .2s;position:relative}
.slot.over{border-color:var(--cyan);background:rgba(34,211,238,0.1);transform:scale(1.02)}
.slot.filled{border-style:solid;border-color:var(--cyan);background:var(--card)}
.slot-lbl{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:8px}
.slot-cnt{position:absolute;top:12px;right:12px;font-size:.8rem;color:var(--cyan);font-weight:600}
.hint{font-size:.9rem;color:var(--text3);text-align:center;padding:14px 0}
.t-row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:8px;font-size:.95rem;font-weight:600;cursor:grab;margin-bottom:6px;transition:all .15s}
.t-row:active{cursor:grabbing}
.t-row .ti{display:flex;align-items:center;gap:10px}
.t-row .rm{background:none;border:none;cursor:pointer;color:var(--text3);font-size:18px;width:26px;height:26px;border-radius:4px;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .15s}
.t-row:hover .rm{opacity:1}
.t-row .rm:hover{background:var(--magenta);color:#000}
.rec{margin-top:10px;display:flex;align-items:center;gap:6px}
.rec input{flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:6px;font-size:.85rem;outline:none;min-width:0;font-family:inherit}
.rec input::placeholder{color:var(--text3)}
.rec input:focus{border-color:var(--green)}
.rec a{width:34px;height:34px;background:var(--green);color:#000;border-radius:6px;display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:14px;flex-shrink:0;transition:all .15s}
.rec a:hover{filter:brightness(1.15)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;width:min(840px,95vw);max-height:88vh;overflow:hidden;display:flex;flex-direction:column;transform:translateY(20px) scale(.97);transition:transform .25s cubic-bezier(.175,.885,.32,1.1)}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{padding:24px 30px 20px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;background:var(--surface)}
.modal-header h2{font-size:1.4rem;font-weight:700;letter-spacing:0.5px}
.modal-header p{font-size:.9rem;color:var(--text3);margin-top:3px}
.modal-actions{display:flex;gap:10px;align-items:center}
.modal-close{background:var(--card);border:1px solid var(--border);color:var(--text2);width:38px;height:38px;border-radius:6px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--magenta);color:#000;border-color:var(--magenta)}
.print-btn{display:flex;align-items:center;gap:6px;padding:10px 18px;border-radius:6px;background:var(--cyan);color:#000;border:none;font-size:.95rem;font-weight:700;cursor:pointer;font-family:inherit}
.print-btn:hover{filter:brightness(1.1)}
.modal-body{padding:26px 30px;overflow-y:auto;background:var(--bg)}
.sum-week-badge{display:inline-block;background:linear-gradient(135deg,var(--cyan),var(--magenta));color:#000;font-size:.9rem;font-weight:700;padding:7px 16px;border-radius:8px;margin-bottom:22px}
.sum-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:26px}
.sum-kpi{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:18px 20px;text-align:center}
.sum-kpi .kv{font-size:2.1rem;font-weight:700}
.sum-kpi .kl{font-size:.75rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.sum-table{width:100%;border-collapse:collapse;font-size:.95rem}
.sum-table th{background:var(--surface);padding:14px 16px;text-align:left;font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2);border-bottom:2px solid var(--border)}
.sum-table td{padding:14px 16px;border-bottom:1px solid var(--border);vertical-align:middle}
.sum-table tr:last-child td{border-bottom:none}
.sum-table tr:hover td{background:var(--surface)}
.td-day{font-weight:700;color:var(--cyan);font-size:.95rem}
.td-name{display:flex;align-items:center;gap:10px;font-weight:600}
.td-rec a{display:inline-flex;align-items:center;gap:5px;color:var(--green);font-size:.9rem;font-weight:600;text-decoration:none;padding:5px 12px;background:rgba(16,185,129,0.15);border-radius:6px}
.td-rec a:hover{background:var(--green);color:#000}
.td-empty{color:var(--text3);font-size:.9rem;font-style:italic}
.sum-person-section{margin-top:30px}
.sum-section-title{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text2);margin-bottom:14px}
.sum-person-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px}
.sum-person-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px}
.sum-person-card .pcount{font-size:1.6rem;font-weight:700;margin-left:auto;color:var(--cyan)}
.sum-person-card .pname{font-size:.95rem;font-weight:600}
.sum-person-card .psub{font-size:.8rem;color:var(--text3)}
.no-data{text-align:center;padding:44px 24px;color:var(--text3);font-size:1rem}
.no-data span{font-size:2.8rem;display:block;margin-bottom:14px}
.toast{position:fixed;bottom:24px;right:24px;background:var(--card);border:1px solid var(--border);color:var(--text);padding:14px 22px;border-radius:10px;font-size:.95rem;font-weight:500;transform:translateY(70px);opacity:0;transition:all .3s cubic-bezier(.175,.885,.32,1.275);z-index:9999;max-width:340px}
.toast.show{transform:translateY(0);opacity:1}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}
::-webkit-scrollbar-thumb:hover{background:var(--text3)}
@media (max-width: 1400px) {
  .grid {min-width:1100px; grid-template-columns:repeat(5, minmax(220px, 1fr))}
  .day-col {min-width:220px}
  main {padding:16px 8px}
}
@media print{.modal-overlay{position:static;background:none;display:block}.modal{width:100%;max-height:none;border-radius:0}.modal-actions,.modal-close{display:none!important}body>*:not(.modal-overlay){display:none}}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-icon">âš¡</div>
    <div><h1>Training Scheduler</h1><p>Shared â€¢ Auto-sync</p></div>
  </div>
  <div class="header-right">
    <div class="week-nav">
      <button id="prevW">â€¹</button>
      <span id="wkLabel"></span>
      <button id="nextW">â€º</button>
    </div>
    <button class="btn" id="summaryBtn">ðŸ“Š Summary</button>
  </div>
</header>
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div><h2>Weekly Summary</h2><p id="modalWeekLabel"></p></div>
      <div class="modal-actions">
        <button class="print-btn" onclick="window.print()">ðŸ–¨ Print / PDF</button>
        <button class="modal-close" id="modalClose">Ã—</button>
      </div>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>
<div class="layout">
  <aside>
    <h2>Roster</h2>
    <div class="pool" id="pool"></div>
    <div class="add-section">
      <label>Add Person</label>
      <input id="nameIn" placeholder="Full name..." maxlength="30"/>
      <button id="addBtn">+ Add to Roster</button>
    </div>
  </aside>
  <main>
    <div class="stats" id="stats"></div>
    <div class="grid" id="grid"></div>
  </main>
</div>
<div class="toast" id="toast"></div>

<script>
// App variables and functions
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
const SLOTS = 3;
const COLORS = ['#22d3ee','#ec4899','#10b981','#fbbf24','#8b5cf6','#f97316','#0ea5e9','#14b8a6','#a855f7','#f43f5e'];
let offset = 0, roster = [], schedule = {}, drag = null;

function ini(n){return n.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)}
function rColor(n){return(roster.find(r=>r.name===n)||{color:'#22d3ee'}).color}
function monday(off){const d=new Date(),day=d.getDay();d.setDate(d.getDate()-(day===0?6:day-1)+off*7);d.setHours(0,0,0,0);return d}
function wkKey(off){return 'w'+monday(off).toISOString().slice(0,10)}
function fmtWeek(off){const m=monday(off),f=monday(off);f.setDate(f.getDate()+4);const o={month:'short',day:'numeric'};return m.toLocaleDateString('en-US',o)+' â€“ '+f.toLocaleDateString('en-US',o)}
function dayDate(di,off){const m=monday(off);m.setDate(m.getDate()+di);return m.toLocaleDateString('en-US',{month:'short',day:'numeric'})}

function slotData(day, si) {
  const k = wkKey(offset);
  if (!schedule[k]) schedule[k] = {};
  const key = day + '-' + si;
  if (!schedule[k][key]) schedule[k][key] = { names: [], rec: '' };
  
  const slot = schedule[k][key];
  if (!Array.isArray(slot.names)) slot.names = [];
  if (typeof slot.rec !== 'string') slot.rec = '';
  
  return slot;
}

function saveLocal(){localStorage.setItem('ts_roster',JSON.stringify(roster));localStorage.setItem('ts_schedule',JSON.stringify(schedule))}

function save() {
  saveLocal();
  if (window.saveToFirebase) window.saveToFirebase();
}

function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),4000);
}

function renderPool(){
  const p=document.getElementById('pool');p.innerHTML='';
  roster.forEach(({name,color})=>{
    const el=document.createElement('div');el.className='chip';el.draggable=true;
    el.innerHTML=`<div class="avatar" style="background:${color}">${ini(name)}</div><span>${name}</span>`;
    el.addEventListener('dragstart',e=>{drag={name,from:null};el.classList.add('dragging');e.dataTransfer.effectAllowed='move'});
    el.addEventListener('dragend',()=>el.classList.remove('dragging'));
    p.appendChild(el);
  });
}

function render(){
  document.getElementById('wkLabel').textContent=fmtWeek(offset);
  const grid=document.getElementById('grid');grid.innerHTML='';
  DAYS.forEach((day,di)=>{
    const col=document.createElement('div');col.className='day-col';
    col.innerHTML=`<div class="day-head"><div class="dn">${day}</div><div class="dd">${dayDate(di,offset)}</div></div><div class="slots" id="sc-${day}"></div>`;
    grid.appendChild(col);
    const sc=col.querySelector(`#sc-${day}`);
    for(let si=0;si<SLOTS;si++)sc.appendChild(mkSlot(day,si));
  });
  renderStats();
}

function mkSlot(day,si){
  const d=slotData(day,si);
  const el=document.createElement('div');el.className=`slot${(d.names || []).length?' filled':''}`;
  el.addEventListener('dragover',e=>{e.preventDefault();el.classList.add('over')});
  el.addEventListener('dragleave',()=>el.classList.remove('over'));
  el.addEventListener('drop',e=>{
    e.preventDefault();el.classList.remove('over');if(!drag)return;
    const t=slotData(day,si);
    if ((t.names || []).includes(drag.name)) return;
    if ((t.names || []).length>=1){toast('âš  Session already has a trainee');return}
    if(drag.from){const s=slotData(drag.from.day,drag.from.si);s.names=(s.names || []).filter(n=>n!==drag.name)}
    t.names.push(drag.name);drag=null;
    save();render();renderPool();
  });
  const lbl=document.createElement('div');lbl.className='slot-lbl';lbl.textContent='Session '+(si+1);
  const cnt=document.createElement('div');cnt.className='slot-cnt';cnt.textContent=(d.names || []).length+'/1';
  el.appendChild(lbl);el.appendChild(cnt);
  if(!(d.names || []).length){
    const h=document.createElement('div');h.className='hint';h.textContent='Drop trainee here';el.appendChild(h);
  }else{
    (d.names || []).forEach(name=>{
      const c=rColor(name),row=document.createElement('div');row.className='t-row';row.draggable=true;
      row.style.cssText=`background:rgba(${parseInt(c.slice(1,3),16)},${parseInt(c.slice(3,5),16)},${parseInt(c.slice(5,7),16)},0.12);border-left:4px solid ${c}`;
      row.innerHTML=`<div class="ti"><div class="avatar" style="background:${c};width:30px;height:30px;font-size:.7rem">${ini(name)}</div>${name}</div><button class="rm">Ã—</button>`;
      row.addEventListener('dragstart',e=>{drag={name,from:{day,si}};e.dataTransfer.effectAllowed='move'});
      row.querySelector('.rm').addEventListener('click',()=>{const s=slotData(day,si);s.names=(s.names || []).filter(n=>n!==name);save();render();renderPool()});
      el.appendChild(row);
    });
  }
  const rec=document.createElement('div');rec.className='rec';
  const inp=document.createElement('input');inp.type='url';inp.placeholder='Recording URL...';inp.value=d.rec||'';
  const lnk=document.createElement('a');lnk.target='_blank';lnk.textContent='â–¶';
  const updL=()=>{const v=inp.value.trim();lnk.href=v||'#';lnk.style.display=v?'flex':'none'};updL();
  inp.addEventListener('input',()=>{d.rec=inp.value;save();updL()});
  rec.appendChild(inp);rec.appendChild(lnk);el.appendChild(rec);return el;
}

function renderStats(){
  const bar=document.getElementById('stats');bar.innerHTML='';
  const wk=schedule[wkKey(offset)]||{};let total=0,withRec=0,filled=0;const pc={};
  DAYS.forEach(day=>{for(let si=0;si<SLOTS;si++){const d=wk[day+'-'+si]||{names:[]};if((d.names||[]).length){filled++;(d.names||[]).forEach(n=>{pc[n]=(pc[n]||0)+1;total});if(d.rec)withRec++}}});
  const all=DAYS.length*SLOTS,top=Object.entries(pc).sort((a,b)=>b[1]-a[1])[0];
  [{l:'Sessions',v:total,c:'#22d3ee'},{l:'Slots Filled',v:filled+'/'+all,c:'#10b981'},{l:'Recordings',v:withRec,c:'#fbbf24'},...(top?[{l:'Top Trainee',v:top[0],c:'#ec4899'}]:[])].forEach(({l,v,c})=>{
    const s=document.createElement('div');s.className='stat';
    s.innerHTML=`<div class="sl">${l}</div><div class="sv" style="color:${c}">${v}</div>`;bar.appendChild(s);
  });
}

function openSummary(){
  const overlay=document.getElementById('modalOverlay'),body=document.getElementById('modalBody');
  document.getElementById('modalWeekLabel').textContent=fmtWeek(offset);
  overlay.classList.add('open');
  const wk=schedule[wkKey(offset)]||{};let totalSessions=0,withRec=0,filled=0;const pc={},rows=[];
  DAYS.forEach((day,di)=>{const date=dayDate(di,offset);for(let si=0;si<SLOTS;si++){const d=wk[day+'-'+si]||{names:[]};const hasName=(d.names||[]).length>0;rows.push({day,date,si,name:hasName?d.names[0]:null,rec:hasName&&d.rec?d.rec:null});if(hasName){filled++;totalSessions++;pc[d.names[0]]=(pc[d.names[0]]||0)+1;if(d.rec)withRec++}}});
  if(totalSessions===0){body.innerHTML='<div class="no-data"><span>ðŸ“­</span>No sessions logged yet.<br>Drag trainees into sessions to get started.</div>';return}
  const pct=Math.round(filled/(DAYS.length*SLOTS)*100);
  let html=`<div class="sum-week-badge">Week of ${fmtWeek(offset)}</div><div class="sum-kpis"><div class="sum-kpi"><div class="kv" style="color:#22d3ee">${totalSessions}</div><div class="kl">Total Sessions</div></div><div class="sum-kpi"><div class="kv" style="color:#10b981">${pct}%</div><div class="kl">Completion</div></div><div class="sum-kpi"><div class="kv" style="color:#fbbf24">${withRec}</div><div class="kl">Recordings</div></div><div class="sum-kpi"><div class="kv" style="color:#ec4899">${Object.keys(pc).length}</div><div class="kl">Trainees</div></div></div><table class="sum-table"><thead><tr><th>Day</th><th>Date</th><th>Session</th><th>Trainee</th><th>Recording</th></tr></thead><tbody>`;
  let lastDay='';
  rows.forEach(({day,date,si,name,rec})=>{
    const dc=day!==lastDay?`<td class="td-day" rowspan="${SLOTS}">${day}</td>`:'';if(day!==lastDay)lastDay=day;
    const color=name?rColor(name):'#94a3b8';
    const nc=name?`<div class="td-name"><div class="avatar" style="background:${color};width:26px;height:26px;font-size:.65rem">${ini(name)}</div>${name}</div>`:'<span class="td-empty">â€” unscheduled â€”</span>';
    const rc=rec?`<a href="${rec}" target="_blank">â–¶ Watch</a>`:'<span class="td-empty">No link</span>';
    html+=`<tr>${dc}<td style="color:#cbd5e1">${date}</td><td style="font-weight:600">Session ${si+1}</td><td>${nc}</td><td class="td-rec">${rc}</td></tr>`;
  });
  html+='</tbody></table>';
  if(Object.keys(pc).length){html+='<div class="sum-person-section"><div class="sum-section-title">Trainee Breakdown</div><div class="sum-person-grid">';Object.entries(pc).sort((a,b)=>b[1]-a[1]).forEach(([name,count])=>{const color=rColor(name);html+=`<div class="sum-person-card"><div class="avatar" style="background:${color}">${ini(name)}</div><div><div class="pname">${name}</div><div class="psub">${count} session${count>1?'s':''}</div></div><div class="pcount">${count}</div></div>`});html+='</div></div>'}
  body.innerHTML=html;
}

// Event listeners
document.getElementById('summaryBtn').addEventListener('click',openSummary);
document.getElementById('modalClose').addEventListener('click',()=>document.getElementById('modalOverlay').classList.remove('open'));
document.getElementById('modalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open')});
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.getElementById('modalOverlay').classList.remove('open')});
document.getElementById('addBtn').addEventListener('click',()=>{
  const inp=document.getElementById('nameIn'),name=inp.value.trim();if(!name)return;
  if(roster.find(r=>r.name.toLowerCase()===name.toLowerCase())){toast('âš  Already in roster');return}
  roster.push({name,color:COLORS[roster.length%COLORS.length]});inp.value='';
  save();renderPool();toast('âœ“ '+name+' added');
});
document.getElementById('nameIn').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('addBtn').click()});
document.getElementById('prevW').addEventListener('click',()=>{offset--;render()});
document.getElementById('nextW').addEventListener('click',()=>{offset++;render()});

// Boot
function boot(){
  try{
    const r=localStorage.getItem('ts_roster');if(r)roster=JSON.parse(r);
    const s=localStorage.getItem('ts_schedule');if(s)schedule=JSON.parse(s);
  }catch{}
  if(!roster.length)['Tyler','Julie','Adam','Carnell','Kris','Cameron','Cynthia'].forEach((n,i)=>roster.push({name:n,color:COLORS[i]}));
  renderPool();render();
  // Push local data to Firebase on load
  setTimeout(() => {
    if (window.saveToFirebase) window.saveToFirebase();
    toast('Connected to shared storage â€“ changes sync across devices!');
  }, 1000);
}
boot();
</script>
</body>
</html>
