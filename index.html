<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allstate CRM - Enhanced</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* Your existing CSS here (unchanged) */
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <!-- Replace icon with official Allstate logo -->
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6f/Allstate_logo.svg" alt="Allstate Logo" style="height: 32px;"/>
        Allstate CRM
      </div>
      <div class="header-stats">
        <div class="stat-item"><i class="fa fa-users"></i> <span id="leadCount">0</span> Leads</div>
        <div class="stat-item"><i class="fa fa-calendar-check"></i> <span id="todayApptCount">0</span> Appointments Today</div>
      </div>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="leads"><i class="fa fa-users"></i> Leads</div>
    <div class="tab" data-tab="schedule"><i class="fa fa-calendar-alt"></i> Schedule</div>
    <div class="tab" data-tab="text-templates"><i class="fa fa-comment-dots"></i> Text Templates</div>
  </div>

  <div class="content" id="leads">
    <!-- Your existing leads UI here -->
    <div class="leads-header">
      <div class="leads-title">Leads</div>
      <div class="search-box">
        <i class="fa fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search leads..." />
      </div>
      <button class="btn btn-primary" id="addLeadBtn"><i class="fa fa-user-plus"></i> Add Lead</button>
    </div>
    <div class="lead-grid" id="leadGrid"></div>
  </div>

  <div class="content" id="schedule" style="display:none;">
    <div id="calendarView"></div>
  </div>

  <div class="content" id="text-templates" style="display:none;">
    <h2>Text Templates</h2>
    <textarea id="templateInput" rows="4" placeholder="Add a new text template..." style="width:100%;"></textarea>
    <button class="btn btn-primary" style="margin-top:0.5rem;" onclick="saveTemplate()"><i class="fa fa-save"></i> Save Template</button>
    <div id="templatesList" style="margin-top:1rem;"></div>
  </div>

  <!-- Popup for lead details -->
  <div class="overlay" id="popupOverlay"></div>
  <div class="popup" id="leadPopup">
    <div class="popup-header">
      <div class="popup-title" id="popupTitle">Lead Details</div>
      <button class="close-btn" onclick="closePopup()"><i class="fa fa-times"></i></button>
    </div>
    <form id="leadForm">
      <input type="hidden" id="leadId" />
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" type="text" id="leadName" required />
      </div>
      <div class="form-group">
        <label class="form-label">Phone</label>
        <input class="form-input" type="text" id="leadPhone" required />
      </div>
      <div class="form-group">
        <label class="form-label">Appointment Date/Time</label>
        <input class="form-input" type="datetime-local" id="leadAppt" required />
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="leadNotes"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">File URL</label>
        <input class="form-input" type="url" id="leadFileUrl" placeholder="https://..." />
      </div>
      <div class="popup-actions">
        <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> Save</button>
        <button type="button" class="btn btn-danger" id="deleteLeadBtn" style="display:none;"><i class="fa fa-trash"></i> Delete</button>
      </div>
    </form>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <div class="notification-content">
      <span class="notification-icon"><i class="fa fa-check-circle"></i></span>
      <div class="notification-text">
        <div class="notification-title" id="notificationTitle"></div>
        <div class="notification-message" id="notificationMessage"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Data & Utilities ---
    let leads = JSON.parse(localStorage.getItem('leads') || '[]');
    let templates = JSON.parse(localStorage.getItem('textTemplates') || '[]');
    let editingLeadId = null;

    function saveLeads() {
      localStorage.setItem('leads', JSON.stringify(leads));
    }
    function saveTemplatesToStorage() {
      localStorage.setItem('textTemplates', JSON.stringify(templates));
    }
    function formatDateTime(dt) {
      if (!dt) return '';
      const d = new Date(dt);
      return d.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
    }
    function showNotification(title, message, type='success') {
      const n = document.getElementById('notification');
      document.getElementById('notificationTitle').textContent = title;
      document.getElementById('notificationMessage').textContent = message;
      n.className = 'notification ' + type;
      n.style.display = 'block';
      setTimeout(() => { n.style.display = 'none'; }, 2500);
    }

    // --- Tabs ---
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
        document.getElementById(tab.dataset.tab).style.display = '';
        if (tab.dataset.tab === 'schedule') renderCalendar();
        if (tab.dataset.tab === 'text-templates') renderTemplates();
      });
    });

    // --- Leads ---
    function renderLeads() {
      // Sort by soonest appointment date/time
      leads.sort((a, b) => new Date(a.appointmentDate) - new Date(b.appointmentDate));
      const grid = document.getElementById('leadGrid');
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      grid.innerHTML = '';
      let filtered = leads.filter(lead =>
        lead.name.toLowerCase().includes(search) ||
        lead.phone.toLowerCase().includes(search) ||
        (lead.notes && lead.notes.toLowerCase().includes(search))
      );
      filtered.forEach(lead => {
        const card = document.createElement('div');
        card.className = 'lead-card';
        card.onclick = () => openLeadPopup(lead);
        card.innerHTML = `
          <div class="lead-header">
            <div>
              <div class="lead-name">${lead.name}</div>
              <div class="lead-phone"><i class="fa fa-phone"></i> ${lead.phone}</div>
            </div>
            <div class="lead-status">${lead.status || 'Active'}</div>
          </div>
          <div class="lead-notes">${lead.notes || ''}</div>
          <div class="lead-footer">
            <div class="lead-time"><i class="fa fa-clock"></i> ${formatDateTime(lead.appointmentDate)}</div>
          </div>
        `;
        grid.appendChild(card);
      });
      document.getElementById('leadCount').textContent = leads.length;
    }
    document.getElementById('searchInput').addEventListener('input', renderLeads);

    // --- Add/Edit Lead Popup ---
    function openLeadPopup(lead = null) {
      editingLeadId = lead ? lead.id : null;
      document.getElementById('leadId').value = lead ? lead.id : '';
      document.getElementById('leadName').value = lead ? lead.name : '';
      document.getElementById('leadPhone').value = lead ? lead.phone : '';
      document.getElementById('leadAppt').value = lead && lead.appointmentDate ? lead.appointmentDate.slice(0,16) : '';
      document.getElementById('leadNotes').value = lead ? lead.notes : '';
      document.getElementById('leadFileUrl').value = lead ? (lead.fileUrl || '') : '';
      document.getElementById('popupTitle').textContent = lead ? 'Edit Lead' : 'Add Lead';
      document.getElementById('deleteLeadBtn').style.display = lead ? '' : 'none';
      document.getElementById('popupOverlay').style.display = 'block';
      document.getElementById('leadPopup').style.display = 'block';
    }
    function closePopup() {
      document.getElementById('popupOverlay').style.display = 'none';
      document.getElementById('leadPopup').style.display = 'none';
      editingLeadId = null;
    }
    document.getElementById('addLeadBtn').onclick = () => openLeadPopup();

    document.getElementById('leadForm').onsubmit = function(e) {
      e.preventDefault();
      const id = document.getElementById('leadId').value || Date.now().toString();
      const name = document.getElementById('leadName').value;
      const phone = document.getElementById('leadPhone').value;
      const appointmentDate = document.getElementById('leadAppt').value;
      const notes = document.getElementById('leadNotes').value;
      const fileUrl = document.getElementById('leadFileUrl').value;
      let idx = leads.findIndex(l => l.id === id);
      if (idx >= 0) {
        leads[idx] = { ...leads[idx], name, phone, appointmentDate, notes, fileUrl };
        showNotification('Lead Updated', 'Lead information updated successfully.');
      } else {
        leads.push({ id, name, phone, appointmentDate, notes, fileUrl });
        showNotification('Lead Added', 'New lead added successfully.');
      }
      saveLeads();
      closePopup();
      renderLeads();
      renderCalendar();
    };
    document.getElementById('deleteLeadBtn').onclick = function() {
      if (editingLeadId) {
        leads = leads.filter(l => l.id !== editingLeadId);
        saveLeads();
        showNotification('Lead Deleted', 'Lead removed.');
        closePopup();
        renderLeads();
        renderCalendar();
      }
    };
    document.getElementById('popupOverlay').onclick = closePopup;

    // --- Calendar/Schedule ---
    let calendar;
    function renderCalendar() {
      if (!document.getElementById('calendarView')) return;
      if (calendar) calendar.destroy();
      calendar = new FullCalendar.Calendar(document.getElementById('calendarView'), {
        initialView: 'dayGridMonth',
        height: 600,
        events: leads.filter(l => l.appointmentDate).map(lead => ({
          id: lead.id,
          title: lead.name + ' (' + lead.phone + ')',
          start: lead.appointmentDate,
          extendedProps: { fileUrl: lead.fileUrl }
        })),
        eventClick: function(info) {
          const lead = leads.find(l => l.id === info.event.id);
          if (lead && lead.fileUrl) {
            window.open(lead.fileUrl, '_blank');
          } else if (lead) {
            openLeadPopup(lead);
          }
        }
      });
      calendar.render();
      // Update appointments today count
      const today = new Date().toISOString().slice(0,10);
      const todayCount = leads.filter(l => l.appointmentDate && l.appointmentDate.slice(0,10) === today).length;
      document.getElementById('todayApptCount').textContent = todayCount;
    }

    // --- Text Templates ---
    function renderTemplates() {
      const list = document.getElementById('templatesList');
      list.innerHTML = '';
      if (templates.length === 0) {
        list.innerHTML = '<div style="color:var(--text-secondary);">No templates saved.</div>';
        return;
      }
      templates.forEach((tpl, i) => {
        const div = document.createElement('div');
        div.style = "background:var(--bg-secondary);padding:1rem;border-radius:8px;margin-bottom:0.75rem;display:flex;align-items:center;justify-content:space-between;";
        div.innerHTML = `
          <span style="white-space:pre-line;">${tpl}</span>
          <button class="btn btn-danger" style="font-size:0.9em;padding:0.3em 0.8em;" onclick="deleteTemplate(${i})"><i class="fa fa-trash"></i></button>
        `;
        list.appendChild(div);
      });
    }
    function saveTemplate() {
      const val = document.getElementById('templateInput').value.trim();
      if (!val) {
        showNotification('Error', 'Template cannot be empty.', 'warning');
        return;
      }
      templates.push(val);
      saveTemplatesToStorage();
      document.getElementById('templateInput').value = '';
      renderTemplates();
      showNotification('Template Saved', 'Text template saved.');
    }
    function deleteTemplate(idx) {
      templates.splice(idx, 1);
      saveTemplatesToStorage();
      renderTemplates();
      showNotification('Template Deleted', 'Text template deleted.');
    }
    window.saveTemplate = saveTemplate;
    window.deleteTemplate = deleteTemplate;

    // --- Initial Render ---
    renderLeads();
    renderCalendar();
    renderTemplates();

    // --- Responsive: re-render calendar on tab switch ---
    window.addEventListener('resize', () => {
      if (calendar) calendar.updateSize();
    });
  </script>
</body>
</html>
